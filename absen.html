<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" type="image/svg+xml" href="asset/icon.svg">
  <title>Panwaslu Kecamatan Cibinong</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <section class="container">
    <div class="centered-image"><img src="asset/logo.png" alt="Logo" /></div>
    <!-- <header>ABSENSI PIKET</header> -->
    <form action="#" class="form" onsubmit="submitForm(event)">
      <div class="input-box">
        <label>Nama Lengkap</label>
        <input id="nama" type="text" placeholder="Nama lengkap" required />
      </div>
      <div class="column">
        <div class="input-box address">
          <label>Jabatan</label>
          <div class="select-box">
            <select id="jabatan" required>
              <option hidden>Pilih Jabatan</option>
              <option>PKD Batulawang</option>
              <option>PKD Ciburial</option>
              <option>PKD Cikangkareng</option>
              <option>PKD Cimaskara</option>
              <option>PKD Girijaya</option>
              <option>PKD Hamerang</option>
              <option>PKD Mekarmukti</option>
              <option>PKD Padasuka</option>
              <option>PKD Pamoyanan</option>
              <option>PKD Pananggapan</option>
              <option>PKD Panyindangan</option>
              <option>PKD Sukajadi</option>
              <option>PKD Sukamekar</option>
              <option>PKD Wargaluyu</option>
            </select>
          </div>
        </div>
      </div>
      <div class="column">
        <div class="input-box">
          <h7 class="font-lain" id="waktu-piket"></h7>
          <h8 class="font-gagal" id="ip-message"> </h8>
        </div>
      </div>
      <div class="input-box-camera">
        <video id="camera" width="150" height="150" autoplay></video>
      </div>
      <button type="submit" id="submit-btn" disabled>Absen Sekarang</button>
      <h7 class="font-lain" id="output"></h7>
      <button type="button" onclick="resetLocalStorage()">Reset Data Absen</button>
    </form>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
  var hasilabsen = JSON.parse(localStorage.getItem('hasilabsen')) || [];
  function displayHasilAbsen() {
    var outputElement = document.getElementById('output');
    var hasilAbsenText = '';
    hasilabsen.forEach(function (data) {
      hasilAbsenText += `${data.nama} | ${data.jabatan} | ${data.waktuAbsen}<br>`;
    });
    outputElement.innerHTML = hasilAbsenText;
  }

  function saveDataToLocalStorage() {
    localStorage.setItem('hasilabsen', JSON.stringify(hasilabsen));
  }

  function popupku(status,kata) {
    Swal.fire({
      position: 'top-end',
      icon: status,
      title: 'Absen',
      text: kata,
      showConfirmButton: false,
      timer: 2000
    })
  }

  function resetLocalStorage() {
      localStorage.removeItem('hasilabsen');
      hasilabsen = []; // Clear the data in the array as well
      var outputElement = document.getElementById('output');
      outputElement.innerHTML = 'Data absen sudah di reset';
    }

    function getIP(callback) {
      const url = 'https://api.ipify.org?format=json';
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const ip = data.ip.split('.')[0]
          callback(ip);
        });
    }

    function checkIP() {
      const allowedIP = '180';
      const ipMessage = document.getElementById('ip-message');
      getIP(ip => {
        if (ip !== allowedIP) {
          ipMessage.innerText = 'Anda sedang tidak dikantor !!!\n';
          document.getElementById('submit-btn').disabled = true;
        } else {
          document.getElementById('submit-btn').disabled = false;
        }
      });
    }
    window.onload = checkIP;

    var inputWaktuPiket = document.getElementById("waktu-piket");
    var waktuSaatIni = new Date();
    var jam = waktuSaatIni.getHours();
    var menit = waktuSaatIni.getMinutes();
    var waktuFormatted = (jam < 10 ? "0" + jam : jam) + ":" + (menit < 10 ? "0" + menit : menit);

    var currentDate = new Date();
    var formattedDate = currentDate.toISOString().split("T")[0];
    var waktuPiket = "Waktu Absen " + waktuFormatted + " | " + formattedDate + "\n";
    inputWaktuPiket.innerText = waktuPiket;

    function submitForm(event) {
  event.preventDefault(); // Prevent the form from submitting normally

  var nama = document.getElementById('nama').value;
  var jabatan = document.getElementById('jabatan').value;

  if (nama === '' || jabatan === 'Pilih Jabatan') {
    alert('Mohon lengkapi sebelum mengirim.');
  } else {
    var currentDate = new Date();
    var formattedDate = currentDate.toISOString().split("T")[0];
    var jam = currentDate.getHours();
    var menit = currentDate.getMinutes();
    var waktuFormatted = (jam < 10 ? "0" + jam : jam) + ":" + (menit < 10 ? "0" + menit : menit);
    var waktuPiket = "Waktu Absen " + waktuFormatted + " | " + formattedDate + "\n";
    // Check if the formattedDate already exists in hasilabsen
    var isDateAlreadyExists = hasilabsen.some(function(data) {
      return data.waktuAbsen.includes(formattedDate);
    });

    if (isDateAlreadyExists) {
      displayHasilAbsen();
      popupku('warning','Anda sudah absen pada tanggal ini.');
    } else {
      var data = {
        nama: nama,
        jabatan: jabatan,
        waktuAbsen: `${formattedDate} | ${waktuFormatted}`
      };
      hasilabsen.push(data); // Add the new data to the hasilabsen array
      var outputElement = document.getElementById('output');
      outputElement.innerHTML = `Absen Sukses!!<br>${data.nama} | ${formattedDate}`
      saveDataToLocalStorage();
      displayHasilAbsen();
      popupku('success','Berhasil melakukan absen');
    }
  }
}

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function (stream) {
        var video = document.getElementById('camera');
        video.srcObject = stream;
        video.play();
      })
      .catch(function (error) {
        console.log('Unable to access the camera: ', error);
      });
      
  </script>
</body>

</html>
